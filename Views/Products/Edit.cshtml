@model ChainStoreSalesManagement.Domain.Entities.Product

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
    Layout = "~/Views/Shared/_LayoutSapo.cshtml";
}

<style>
    .main-container {
        max-width: 1080px;
        margin: 0 auto;
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .page-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .content-wrapper {
        display: flex;
        gap: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        min-height: 600px;
    }
    
    .left-panel {
        flex: 1;
        padding: 30px;
        border-right: 1px solid #e9ecef;
    }
    
    .right-panel {
        width: 350px;
        padding: 30px;
        background: #f8f9fa;
    }
    
    .section {
        margin-bottom: 30px;
        padding-bottom: 25px;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 16px;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 6px;
        display: block;
        font-size: 14px;
    }
    
    .required {
        color: #dc3545;
    }
    
    .form-control, .form-select {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px 12px;
        font-size: 14px;
        transition: border-color 0.15s ease-in-out;
        background: white;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }
    
    .text-danger {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
    }
    
    .price-row {
        display: flex;
        gap: 12px;
    }
    
    .price-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    /* Image Upload Section */
    .image-section {
        margin-bottom: 20px;
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .image-item {
        position: relative;
        aspect-ratio: 1;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    
    .image-item:hover {
        border-color: #007bff;
    }
    
    .image-item.has-image {
        border-style: solid;
        border-color: #ddd;
        padding: 4px;
    }
    
    .image-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .image-item .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .image-item .remove-btn:hover {
        background: #c82333;
    }
    
    .add-image-btn {
        background: none;
        border: none;
        color: #666;
        font-size: 11px;
        text-align: center;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    
    .add-image-btn i {
        font-size: 20px;
    }
    
    .add-url-section {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #007bff;
        font-size: 12px;
        cursor: pointer;
    }
    
    .add-url-section:hover {
        text-decoration: underline;
    }
    
    .file-input {
        display: none;
    }
    
    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: white;
        border-top: 1px solid #e9ecef;
        border-radius: 0 0 8px 8px;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        border: 1px solid;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-primary {
        background: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        border-color: #0056b3;
    }
    
    .btn-secondary {
        background: white;
        border-color: #6c757d;
        color: #6c757d;
    }
    
    .btn-secondary:hover {
        background: #f8f9fa;
        text-decoration: none;
        color: #6c757d;
    }
    
    .btn-danger {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
        border-color: #c82333;
        text-decoration: none;
    }
</style>

<div class="main-container">
    <form asp-action="Edit" enctype="multipart/form-data">
        <input type="hidden" asp-for="ProductId" />
        <input type="hidden" asp-for="CreatedAt" />
        <input type="hidden" asp-for="RowVersion" />
        
        <div class="content-wrapper">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Thông tin sản phẩm -->
                <div class="section">
                    <h3 class="section-title">Thông tin sản phẩm</h3>
                    
                    <div class="form-group">
                        <label asp-for="Name" class="form-label">Tên sản phẩm <span class="required">*</span></label>
                        <input asp-for="Name" class="form-control" placeholder="Nhập tên sản phẩm" maxlength="300" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    
                    <div class="price-row">
                        <div class="form-group">
                            <label asp-for="Code" class="form-label">Mã Code</label>
                            <input asp-for="Code" class="form-control" placeholder="Nhập mã code" />
                            <span asp-validation-for="Code" class="text-danger"></span>
                        </div>
                        
                        <div class="form-group">
                            <label asp-for="Sku" class="form-label">SKU <span class="required">*</span></label>
                            <input asp-for="Sku" class="form-control" placeholder="Nhập mã SKU" maxlength="100" />
                            <span asp-validation-for="Sku" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Barcode" class="form-label">Mã vạch Barcode</label>
                        <input asp-for="Barcode" class="form-control" placeholder="Nhập mã vạch Barcode" maxlength="128" />
                        <span asp-validation-for="Barcode" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Unit" class="form-label">Đơn vị tính</label>
                        <input asp-for="Unit" class="form-control" placeholder="Nhập đơn vị tính" />
                        <span asp-validation-for="Unit" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Description" class="form-label">Mô tả sản phẩm</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Nhập mô tả sản phẩm..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="OptionSummary" class="form-label">Tóm tắt tùy chọn</label>
                        <input asp-for="OptionSummary" class="form-control" placeholder="Nhập tóm tắt tùy chọn" maxlength="300" />
                        <span asp-validation-for="OptionSummary" class="text-danger"></span>
                    </div>
                    
                    <div class="price-row">
                        <div class="form-group">
                            <label asp-for="CostPrice" class="form-label">Giá vốn</label>
                            <input asp-for="CostPrice" class="form-control" type="number" step="0.01" placeholder="0.00" />
                            <span asp-validation-for="CostPrice" class="text-danger"></span>
                        </div>
                        
                        <div class="form-group">
                            <label asp-for="Price" class="form-label">Giá bán <span class="required">*</span></label>
                            <input asp-for="Price" class="form-control" type="number" step="0.01" placeholder="0.00" />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="price-row">
                        <div class="form-group">
                            <input asp-for="CanSell" type="checkbox" id="CanSell" />
                            <label for="CanSell" style="margin-left: 8px;">Cho phép bán</label>
                        </div>
                        
                        <div class="form-group">
                            <input asp-for="TrackSerial" type="checkbox" id="TrackSerial" />
                            <label for="TrackSerial" style="margin-left: 8px;">Theo dõi số seri</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Ảnh sản phẩm -->
                <div class="image-section">
                    <h3 class="section-title">Ảnh sản phẩm</h3>
                    
                    <div class="image-grid" id="imageGrid">
                        @if (Model.Images != null && Model.Images.Any())
                        {
                            @foreach (var image in Model.Images.Where(i => !i.IsDeleted))
                            {
                                <div class="image-item has-image" data-image-id="@image.ImageId">
                                    <img src="@image.FilePath" alt="Product Image" />
                                    <button type="button" class="remove-btn" onclick="removeExistingImage(this, @image.ImageId)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            }
                        }
                        
                        <div class="image-item">
                            <button type="button" class="add-image-btn" onclick="document.getElementById('imageFile').click()">
                                <i class="fas fa-plus"></i>
                                Thêm ảnh
                            </button>
                        </div>
                    </div>
                    
                    <div class="add-url-section" onclick="addImageFromUrl()">
                        <i class="fas fa-link"></i>
                        <span>Thêm ảnh từ URL</span>
                    </div>
                    
                    <input type="file" id="imageFile" name="imageFiles" accept=".jpg,.jpeg,.png" multiple class="file-input" />
                    <input type="hidden" id="deletedImageIds" name="deletedImageIds" />
                </div>
                
                <!-- Danh mục -->
                <div class="section">
                    <h3 class="section-title">Phân loại sản phẩm</h3>
                    
                    <div class="form-group">
                        <label asp-for="CategoryId" class="form-label">Danh mục</label>
                        <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.CategoryId">
                            <option value="">Chọn danh mục</option>
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="BrandId" class="form-label">Thương hiệu</label>
                        <select asp-for="BrandId" class="form-select" asp-items="ViewBag.BrandId">
                            <option value="">Chọn thương hiệu</option>
                        </select>
                        <span asp-validation-for="BrandId" class="text-danger"></span>
                    </div>
                </div>
                
                <!-- Cửa hàng -->
                <div class="section">
                    <h3 class="section-title">Thông tin cửa hàng</h3>
                    
                    <div class="form-group">
                        <label asp-for="ShopId" class="form-label">Cửa hàng <span class="required">*</span></label>
                        <select asp-for="ShopId" class="form-select" asp-items="ViewBag.ShopId">
                            <option value="">Chọn cửa hàng</option>
                        </select>
                        <span asp-validation-for="ShopId" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions Bar -->
        <div class="actions-bar">
            <div></div>
            <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-primary">Cập nhật</button>
                <a asp-action="Index" class="btn btn-secondary">Hủy</a>
                <button type="button" class="btn btn-danger" onclick="deleteProduct(@Model.ProductId, '@Model.Name')">Xóa</button>
            </div>
        </div>
    </form>
    
    <!-- Hidden Delete Form -->
    <form id="deleteForm" asp-action="Delete" method="post" style="display: none;">
        <input type="hidden" name="id" id="deleteProductId" />
        @Html.AntiForgeryToken()
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        let selectedFiles = new DataTransfer();
        let deletedImageIds = [];
        
        // Image handling
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.size > 2 * 1024 * 1024) { // 2MB
                    alert('Kích thước file không được vượt quá 2MB');
                    return;
                }
                
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Chỉ chấp nhận file ảnh định dạng JPG, PNG');
                    return;
                }
                
                // Add file to selected files
                selectedFiles.items.add(file);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    addImageToGrid(e.target.result, file);
                };
                reader.readAsDataURL(file);
            });
            
            // Update the file input with all selected files
            document.getElementById('imageFile').files = selectedFiles.files;
        });
        
        function addImageToGrid(imageSrc, file) {
            const imageGrid = document.getElementById('imageGrid');
            const addButton = imageGrid.querySelector('.image-item:not(.has-image)');
            
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item has-image';
            imageItem.setAttribute('data-file-name', file.name);
            imageItem.innerHTML = `
                <img src="${imageSrc}" alt="Product Image" />
                <button type="button" class="remove-btn" onclick="removeNewImage(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            imageGrid.insertBefore(imageItem, addButton);
        }
        
        function removeNewImage(button) {
            const imageItem = button.closest('.image-item');
            const fileName = imageItem.getAttribute('data-file-name');
            
            // Remove file from DataTransfer
            const newDataTransfer = new DataTransfer();
            const fileInput = document.getElementById('imageFile');
            
            for (let i = 0; i < selectedFiles.files.length; i++) {
                if (selectedFiles.files[i].name !== fileName) {
                    newDataTransfer.items.add(selectedFiles.files[i]);
                }
            }
            
            selectedFiles = newDataTransfer;
            fileInput.files = selectedFiles.files;
            
            imageItem.remove();
        }
        
        function removeExistingImage(button, imageId) {
            if (confirm('Bạn có chắc muốn xóa ảnh này?')) {
                const imageItem = button.closest('.image-item');
                imageItem.remove();
                
                // Add to deleted list
                deletedImageIds.push(imageId);
                document.getElementById('deletedImageIds').value = deletedImageIds.join(',');
            }
        }
        
        function addImageFromUrl() {
            const url = prompt('Nhập URL hình ảnh:');
            if (url && url.match(/\.(jpeg|jpg|gif|png)$/)) {
                addImageToGridFromUrl(url);
            } else if (url) {
                alert('URL không hợp lệ. Vui lòng nhập URL hình ảnh có định dạng JPG, PNG, GIF');
            }
        }
        
        function addImageToGridFromUrl(imageSrc) {
            const imageGrid = document.getElementById('imageGrid');
            const addButton = imageGrid.querySelector('.image-item:not(.has-image)');
            
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item has-image';
            imageItem.setAttribute('data-image-url', imageSrc);
            imageItem.innerHTML = `
                <img src="${imageSrc}" alt="Product Image" />
                <button type="button" class="remove-btn" onclick="removeImageUrl(this)">
                    <i class="fas fa-times"></i>
                </button>
                <input type="hidden" name="imageUrls" value="${imageSrc}" />
            `;
            
            imageGrid.insertBefore(imageItem, addButton);
        }
        
        function removeImageUrl(button) {
            const imageItem = button.closest('.image-item');
            imageItem.remove();
        }
        
        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const nameInput = document.querySelector('#Name');
            const skuInput = document.querySelector('#Sku');
            const shopSelect = document.querySelector('#ShopId');
            
            if (!nameInput.value.trim()) {
                alert('Vui lòng nhập tên sản phẩm');
                nameInput.focus();
                e.preventDefault();
                return;
            }
            
            if (!skuInput.value.trim()) {
                alert('Vui lòng nhập mã SKU');
                skuInput.focus();
                e.preventDefault();
                return;
            }
            
            if (!shopSelect.value) {
                alert('Vui lòng chọn cửa hàng');
                shopSelect.focus();
                e.preventDefault();
                return;
            }
        });
        
        // Delete product function
        function deleteProduct(productId, productName) {
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm "' + productName + '"?\nSản phẩm sẽ được chuyển vào trạng thái đã xóa.')) {
                document.getElementById('deleteProductId').value = productId;
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
}
